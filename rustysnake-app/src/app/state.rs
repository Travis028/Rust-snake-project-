// ... (paste the full content of state.rs from the original message) ...
